<project default="create_install" basedir="..">

	<description> 
	build file
	</description>

	<!-- Task definition -->
	<!-- Define classpath for ant-contrib tasks -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" />
	<taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask" />

	<property name="manifestfile" value="pkg_reaxml.xml" />
	<property name="installfileDir" value="packed/" />
	<property name="installfilePrefix" value="pkg_reaxml-" />
	<property name="releaseRemoteDir" value="~/public_html/cwf-extras/" />

	<scriptdef name="increment_version" language="javascript">
		<attribute name="current" />
		<attribute name="property" />
		<![CDATA[
		var current = attributes.get("current");
		var dotidx = current.lastIndexOf(".");
		var buildnum = parseInt(current.slice(dotidx+1));
		project.setProperty(attributes.get("property"),current.substring(0,dotidx+1) + (++buildnum) ) ;
		]]>
	</scriptdef>

	<tstamp>
		<format property="datetime" pattern="yyyy-MM-dd'T'HH:mm:ss.SSS" />
		<format property="newReleaseDate" pattern="yyyy-MM-dd" />
		<format property="newCreationDate" pattern="MMM yyyy" />
	</tstamp>

	<target name="create_install" depends="update_manifest">
		<zip destfile="${installfileDir}${installfilePrefix}${newVersion}.zip" >
			<fileset dir="." excludes=".*/**, **/.DS_Store, tests/**, build/**, .settings/**, vendor/**, packed/**"/>
		</zip>
	</target>
	
	<target name="copy_latest" depends="create_install">
		<copy file="${installfileDir}${installfilePrefix}${newVersion}.zip" tofile="${installfileDir}${installfilePrefix}latest.zip"></copy>
	</target>
	
	<target name="release_upload" depends="create_install">
		<sshexec host="vmres10.auserver.com.au" username="cliftonw" keyfile="~/.ssh/id_rsa" command="mkdir ${releaseRemoteDir}${newVersion}"/>
		<scp keyfile="~/.ssh/id_rsa" todir="cliftonw@vmres10.auserver.com.au:${releaseRemoteDir}${newVersion}" localFile="${installfileDir}${installfilePrefix}${newVersion}.zip"></scp>
	</target>
	
	<target name="get_component_properties">
		<xmlproperty file="${manifestfile}" keepRoot="false" />
		<loadresource property="copyright.stripped">
			<string value="${copyright}" />
			<filterchain>
				<striplinebreaks />
				<replaceregex pattern="[\t]+" replace=" " flags="g" />
			</filterchain>
		</loadresource>
	</target>
	
	<target name="get_version" depends="increment_version" if="skipIncrement">
		<property name="newVersion" value="${version}"/>
	</target>

	<target name="increment_version" depends="get_component_properties" unless="skipIncrement">
		<echo>${version}</echo>
		<increment_version current="${version}" property="newVersion" />
		<echo>${newVersion}</echo>
	</target>

	<target name="update_manifest" depends="get_version" unless="skipIncrement">
		<echo>newversion=${newVersion}</echo>
		<xmltask source="${manifestfile}" dest="${manifestfile}">
			<replace path="/extension/version/text()" withText="${newVersion}"/>
			<replace path="/extension/releaseDate/text()" withText="${newReleaseDate}"/>
			<replace path="/extension/creationDate/text()" withText="${newCreationDate}"/>
		</xmltask>
	</target>

</project>